# Lab2 GenAI
watsonx Orchestrate では、生成AIをカスタムスキルとして外部から呼び出すことが可能ですが、Automation Builder では生成AIのプロンプトを作成し、スキルとして使用することができます。
このLabでは、顧客の特性に応じてメールを生成するプロンプトを作成します。

## 前提条件
 1. watsonx Orchestrateの環境にアクセスできること。
 2. IBM-idを用いてログイン可能であること。

## Automation (生成AI) を作成してみよう
Skill studioで、まず Automation を作成し、そのコンポーネントの1つとして 生成AI のプロンプトを作成することができます。

 1. メニュー(≣)から **Skill studio** を選択します。  
![alt text](image-46.png) 


 2. **Create automation +** をクリックし、新規の Automation を作成します。
 ![alt text](image-47.png)

 3. Create automation のウィンドウで、名前の欄に **YourName_recommendation** と入力し、**Create** をクリックします。  
 ![alt text](image-48.png)


 4. 生成AIを選択します。
 ![alt text](image-49.png)

 5. 名前を **YourName-generate recommendation mail** と入力して、**Create** をクリックします。
![alt text](image-50.png)

6. こちらで、Automation と 生成AIのコンポーネント が作成されました。生成AIのコンポーネントが作成されると、プロンプト・エディターが開きます。
![alt text](image-51.png)

## プロンプトを作成してみよう
プロンプト・エディターを用いて、プロンプトを作成し、出力を生成することができます。

 1. **Prompt** にある **Model:** のプルダウンメニューから、使いたいモデルを選択します。今回は、**mixtral-8x7b-instruct-v01** を選択します。
 ![alt text](<GenAI_images/スクリーンショット (94).png>)

 2. プロンプトを作成します。
    1. **Context** にモデルへの命令文を入力します。今回は、「顧客の特性に応じて、おすすめの観光地を紹介するメール」を生成するプロンプトを作成します。以下の文章を参考に入力します。 (一文ごとに改行してください)   
    ***あなたは、優秀な観光業のマーケターです。***  
    ***観光地のPRをするため、お客様に興味を持ってもらえるメールを送ろうとしています。***  
    ***お客様の特性に合わせて、おすすめの観光地を紹介するメールを日本語で作成してください。***
    ![alt text](GenAI_images/image-10.png)

    2.  **Pronpt input** には、モデルに応答してほしい文章を入力します。以下の文章を参考に入力します。  
    ***お客様は、20代で、写真撮影が好きです。***
    ![alt text](GenAI_images/image-11.png)

    3.  変数を追加します。
     変数は、生成AIの入力として使用されます。変数を使用しない場合も、少なくとも1つの変数を定義する必要があります。
        1. **Variable** の欄で **New variable** をクリックします。
        ![alt text](GenAI_images/スクリーンショット_28-5-2024_112125_dl.watson-orchestrate.ibm.com.jpeg)

        2. 変数に名前を付け、デフォルト値を入力します。 変数の名前と値は String (文字列) でなければなりません。今回は、以下の３つを作成します。(topic は既存の変数のデフォルト値のみ変更してください)
         ![alt text](GenAI_images/image-9.png)

            |Variable|Default value|(意味)|(挿入先)|
            |:---:|:---:|--------|---|
            |topic|観光地|おすすめしたいトピック|Context|
            |age|20|お客様の年代|Prompt input|
            |hobby|写真撮影|お客様の趣味|Prompt input|

        3. 上の表に従って、**Prompt Input** または **Context** の欄で、プロンプトに変数を挿入します。（文字や数値で書いている部分を変数に置き換えます）
            1. 変数名は、二重の中かっこ {} で囲む必要があります。 (例: {{topic}})
            2. 以下の方法で、変数を自動的に挿入できます。
                - **+** アイコン（Add variable）をクリックし、リストから変数を選択します。
                - 欄内で **Ctrl + スペース** をクリックし、変数を選択します。
            3. 完了すると、以下のような文章になります。
             ![alt text](GenAI_images/image-12.png)
            4. 右上の **×** をクリックしてオプションを閉じ、**Generate** をクリックします。すると、文章が生成されますが、以下のように途中で切れてしまっているかと思います。これは、トークンが小さいためです。
            ![alt text](GenAI_images/スクリーンショット_28-5-2024_113523_dl.watson-orchestrate.ibm.com.jpeg)

            
    4. **Parameters** の欄でトークンを設定し、生成される出力の長さを制限します。  
     トークンは、モデルに対して意味を持つ文字の集合です。プロンプトのテキストは、LLMによって処理される前にトークンに変換されます。
        - デフォルトでは、最小値と最大値はそれぞれ 1 と 50 に設定されています。
        - 最小値を 0 にすることはできません。
        - 最大値の制限は、選択したモデルによって異なります。

        右上の歯車(⚙)のマークをクリックし、再びオプションを表示します。
        ![alt text](GenAI_images/スクリーンショット_28-5-2024_113858_dl.watson-orchestrate.ibm.com.jpeg)
        今回は、トークンの最大値 **Max generated tokens** を 1000 に設定します。
        ![alt text](image-52.png)

 3. 右上の **×** をクリックしてオプションを閉じ、**Generate** をクリックします。
 4. **Generated output** の欄で結果を確認します。今回は、文章を最後まで生成できていることが確認できます。  
 **Raw prompt** のアイコン (![alt text](GenAI_images/image-3.png)) をクリックして、未加工のプロンプトを確認することもできます。  
 ![alt text](image-53.png)  
 **View raw prompt** が開き、生成された出力を取得するために使用された context や prompt input、training examples を確認できます。  
 ![alt text](GenAI_images/image-13.png)  
 5. 必要に応じて、より良い結果を得るためにプロンプトを調整します。

## (オプション) Training examples の追加
 プロンプトが生成する出力の精度や品質、安定性を高めるため、プロンプトに例を追加することができます。

 入力と対応する出力のペアを1つ以上指定します。

 1. ページ下部にある **Training examples** の欄で、**New example** をクリックします。
 ![alt text](GenAI_images/image-15.png)
 2. 入力と期待される出力を記入します。以下はトレーニングサンプルの例です。
  
input:
>お客様は30代で、食べ歩きが好きです。

Expected output:  

>こんにちは。
今回は、食べ歩きがお好きなあなたへ、国内で食べ歩きできるおすすめの観光地を3つご紹介します！

>1. 小樽  
>小樽は、レンガ造りの倉庫が並ぶノスタルジックな街です。  
>北海道の新鮮な海鮮類や、生乳を使ったスイーツを楽しめます！

>2. 川越  
>川越は、江戸時代の街並みが広がり、着物を着て風情を楽しむこともできます。  
>名産品であるサツマイモを使ったスイーツが豊富で、食べ歩きしやすい街です！  

>3. 伊勢  
>伊勢神宮へ参拝する道にある「おかげ横丁」は、日本最大の食べ歩きスポットと言われています。  
>伊勢名物「赤福」や、松阪牛、伊勢うどんなど、名産品にあふれた食べ歩きスポットです！  

>弊社では、ご紹介した観光地をはじめとして、食べ歩きにおすすめの観光地を巡るツアーを多数ご用意しております！  
>弊社サイトでも、様々な観光地の魅力や訪問者の声などを掲載しておりますので、ぜひ参考になさってください。  
>この機会にぜひ、旅行を検討されてみてはいかがでしょうか？

 3. ** Generate** をクリックしてプロンプトをテストします。生成された出力の精度が向上しているか確認してみましょう。トレーニングサンプルに基づいた、よりマーケティングのメールらしい文章が生成されています。
 ![alt text](image-54.png)

 **ヒント:** 一般に、指定する入出力のペアが多いほど、結果は良くなります。ただし、例が多すぎる場合は、モデルで許可されている入力の最大トークンと入出力全体の最大トークンのスペースが減ってしまう可能性があります。

## 生成AIを公開してみよう
生成AIのコンポーネントの作成が完了したら、operation を作成してこのコンポーネントを他のユーザーに公開できます。それにより、他のユーザーのAutomationの中で使ってもらったり、スキルをトレーニングしてもらったりすることが可能です。  

 1. **Operation** タブを開きます。
 ![alt text](GenAI_images/スクリーンショット_28-5-2024_124814_dl.watson-orchestrate.ibm.com.jpeg)  
 
 2. **Create operation** をクリックします。
 ![alt text](GenAI_images/スクリーンショット_28-5-2024_125053_dl.watson-orchestrate.ibm.com.jpeg)  
 
 3. **Operation name** の欄に、**YourName_Recommendation** (ハイフンやスペースは使えません) と入力し、**Component** の欄で公開したいコンポーネントを選択します。  
 ![alt text](image-55.png) 

 4. **Save** をクリックします。これで operation が作成されました。次に、このコンポーネントをスキルとして公開します。
 ![alt text](image-56.png)

 5. **Share changes** をクリックします。  
 ![alt text](image-57.png)

 6. **Share** をクリックします。![alt text](image-58.png)
 ポップアップが出てきたら再度 **Share** をクリックします。![alt text](image-59.png)

 7. シェアが完了したら、**Back to YourName_recommendation**をクリックし、元のプロンプト・エディターの画面に戻ります。

 8. 次に **History** のタブをクリックします。
 ![alt text](image-63.png)

 9. 一番上の行の **Version +** をクリックします。
  ![alt text](image-64.png)

 10. ポップアップが出てきたら、バージョンの名前の欄に **1.0.0** と入力して、**Create** をクリックします。
 ![alt text](image-65.png)

 11. 1.0.0 というバージョンが作成されたので、これをスキルとして公開します。**Publish** というタブをクリックします。 
 ![alt text](image-66.png)

 12. 1.0.0 のバージョンをクリックすると、下に詳細が表示されます。**Publish** をクリックします。![alt text](image-67.png)
 確認画面が出てくるので、もう一度 **Publish** をクリックします。  
 ![alt text](image-68.png)

 13. 正常に公開されると、以下のように **Published** と表示されます。![alt text](image-69.png)

 14. 左上のメニュー (≣) から**Skills studio**をクリックし、 **Skills and apps** タブをクリックし、戻ります。**Skills** のタブを選択する、あるいはSkills and appsのページで、作成したスキルを検索します (例:AyamiSato-Recommendation)。
 公開した生成AIのスキルが **Ready to Publish** の状態で表示されます。
 スキルを公開するために、右端の ⁝ から**Enhance this skill**を選択します。
 ![alt text](image-71.png)

 15. 複数のタブがある画面が表示されます。左端の**Name**タブはスキルの名前を表しています。 ![alt text](image-72.png)

 16. **Input**タブをクリックします。この画面は、インポートしたスキルを実行する際の入力項目を表しています。  表示項目を日本語にしてみましょう。![alt text](image-73.png)

 17. 他のタブも同様に動作を確認できます。
    - **Output**タブは、スキルの出力を設定できます。スキルの実行結果を表やテキストの形式で出力することができます。
    - **Security**タブは、スキルを実行するために必要な認証情報を確認できます。
    - **Next Best Skill**タブは、このスキルが使用された後に、次に行うべきスキルとして watsonx Orchestrate が提案するスキルを設定できます。

 18. **Phrases**タブは、チャットからスキルを呼び出すためのフレーズを入力します。多くのフレーズを入力するほど、自然言語からスキルを判断する精度が向上します。日本語で例文を追加します。

    - `観光地のお勧め文を作成して`
    - `おすすめ観光スポット`
    - `お勧め観光地`

    の3つを追加文を入力し**Enter(return)** を押します。 

    ![alt text](image-74.png)
    
    フレーズを自由に追加することも可能です。また、**Auto-generate phrases** をクリックすると、生成AIが自動でフレーズを生成してくれます。  最後に、**Publish**を押します。
    
    ![alt text](image-75.png)

 19. スキルが公開（publish）できたというメッセージが表示されます。
 
 ![alt text](lab2_images/image-65.png)
 
 20. スキルが正常に公開されました。
 
 21. **オプション:** 先ほど公開したスキルをカタログから探して、ステータスを確認してみましょう。ステータスはどのようになっているでしょうか？  

## 観光地のお勧めメールを生成して、スキルをテストしてみよう   

  このセクションでは、作成したスキルをテストする方法について説明します。 スキルをテストするには、カタログからスキルを追加して実行する必要があります。 このための手順は、以下のとおりです。

 1. 左上にあるメニュー (≣) をクリックし、**チャット**を選択して、チャット画面に移動します。
 
  ![alt text](image-76.png)

 2. **Add skills from the catalog** を選択し、前のステップで作成したスキルを選択します。  
  ![alt text](lab2_images/image-13.png)

 3. 検索バーで、`recommendation`を検索します。先ほど作成した**AS-Recommendation** というスキルを開きます。
  ![alt text](image-77.png)

 4. スキルを追加するためには、**Add skill+**をクリックします。
  ![alt text](image-78.png)

 5. スキルが追加された (`Added`) というメッセージが表示されます。  

 ![alt text](image-5.png)

 6. **Chat** 画面に戻ります。追加したスキルが表示されています。

 ![alt text](image-79.png)

 7. スキルをテストするには、先ほどフレーズとして登録した **おすすめ観光地** をチャット欄に入力します。（該当のスキルをクリックしても実行できます）  
 ![alt text](image-7.png)

 11. トピック の欄に`観光地`、年齢層の欄に`20`、趣味の欄に`写真撮影`を入力します。
 入力が完了したら、**Apply** をクリックします。  
 ![alt text](image-80.png)

 12. スキルが実行されると、進行状況が表示され、`working on it` というメッセージが表示されます。 最後に、観光地のお勧めメールのコンテンツが生成されます。  
 ![alt text](image-81.png)

 13. 以上で、メールのコンテンツを生成するテストは完了です。



## お疲れさまでした！
このLabでは、Automationを用いて生成AIのプロンプトを作成しました。
Context や Prompt input を記入したり、変数を設定したりして、出力を生成しました。
また、トークンや Training examples の調整を行うことで、出力の精度を向上させることができました。

 